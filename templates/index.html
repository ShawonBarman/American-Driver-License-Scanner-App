<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Driver License Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            light: '#4da6ff',
                            DEFAULT: '#0066cc',
                            dark: '#004c99',
                        },
                        secondary: {
                            light: '#ff6c91',
                            DEFAULT: '#ff3366',
                            dark: '#cc0033',
                        },
                        neutral: {
                            lightest: '#f8fafc',
                            lighter: '#f1f5f9',
                            light: '#e2e8f0',
                            DEFAULT: '#cbd5e1',
                            dark: '#64748b',
                            darker: '#334155',
                            darkest: '#1e293b',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)',
                        'card': '0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.03)',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        html, body {
            font-family: 'Inter', sans-serif;
            height: 100%;
            overscroll-behavior: none;
            margin: 0;
            padding: 0;
        }
        
        .app-container {
            min-height: 100%;
            display: flex;
            flex-direction: column;
            max-width: 100%;
            overflow-x: hidden;
        }
        
        /* Responsive camera container */
        .camera-container {
            height: 65vh; /* Reduced height */
            width: 100%; /* Full width on mobile */
            max-width: 100%;
            position: relative;
            overflow: hidden;
            margin: 0 auto;
            text-align: center;
        }
        
        /* Make preview card match camera dimensions */
        .preview-card {
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 100%; /* Full width */
            max-width: 450px; /* Maximum width */
            height: auto; /* Auto height */
            aspect-ratio: 1.6/1; /* Same aspect ratio as scanner frame */
            margin: 10px auto;
        }
        
        /* Make the video fit within the container while maintaining aspect ratio */
        .camera-view {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Ensure the scanner frame stays proportional and centered */
        .scanner-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Scanner frame with improved dimensions */
        .scanner-frame {
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 0 0 4000px rgba(0, 0, 0, 0.7);
            border: 2px solid rgba(255, 255, 255, 0.8);
            width: 90%; /* Width relative to container */
            max-width: 450px; /* Maximum width */
            aspect-ratio: 1.6/1; /* ID card aspect ratio */
        }
        
        .scanner-frame::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 2px dashed rgba(255, 255, 255, 0.8);
            border-radius: 14px;
            animation: pulse 1.5s infinite;
            pointer-events: none;
        }
        
        .scanner-guide-lines {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }
        
        .guide-line {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .guide-line-h {
            height: 1px;
            left: 5%;
            right: 5%;
        }
        
        .guide-line-v {
            width: 1px;
            top: 5%;
            bottom: 5%;
        }
        
        .guide-line-h.top {
            top: 33%;
        }
        
        .guide-line-h.bottom {
            bottom: 33%;
        }
        
        .guide-line-v.left {
            left: 33%;
        }
        
        .guide-line-v.right {
            right: 33%;
        }
        
        .corner {
            position: absolute;
            width: 22px;
            height: 22px;
            border-color: rgba(255, 255, 255, 0.9);
            z-index: 10;
        }
        
        .corner-top-left {
            top: 8px;
            left: 8px;
            border-top: 3px solid;
            border-left: 3px solid;
            border-radius: 4px 0 0 0;
        }
        
        .corner-top-right {
            top: 8px;
            right: 8px;
            border-top: 3px solid;
            border-right: 3px solid;
            border-radius: 0 4px 0 0;
        }
        
        .corner-bottom-left {
            bottom: 8px;
            left: 8px;
            border-bottom: 3px solid;
            border-left: 3px solid;
            border-radius: 0 0 0 4px;
        }
        
        .corner-bottom-right {
            bottom: 8px;
            right: 8px;
            border-bottom: 3px solid;
            border-right: 3px solid;
            border-radius: 0 0 4px 0;
        }
        
        .scan-instruction {
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 13px;
            text-align: center;
            backdrop-filter: blur(4px);
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
        }
        
        /* Responsive buttons */
        .btn-primary, .btn-secondary {
            padding: 10px 18px;
            font-size: 14px;
            width: 100%;
            max-width: 250px;
        }
        
        /* Media queries for responsive design */
        @media (min-width: 640px) {
            .camera-container {
                height: 60vh;
                max-width: 500px;
                border-radius: 12px;
            }
            
            .scanner-frame {
                width: 85%;
            }
            
            .btn-primary, .btn-secondary {
                font-size: 15px;
            }
        }
        
        @media (min-width: 1024px) {
            .camera-container {
                height: 55vh;
                max-width: 600px;
            }
            
            .scanner-frame {
                width: 80%;
            }
        }
        
        /* Hide status indicator as requested */
        .status-indicator {
            display: none;
        }
        
        /* Animation for scanner frame */
        @keyframes pulse {
            0% {
                opacity: 0.6;
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 0.6;
            }
        }
        
        /* Animation for scan line */
        .scan-line {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(to right, transparent, rgba(0, 102, 204, 0.8), transparent);
            animation: scan-animation 2s linear infinite;
            z-index: 5;
        }
        
        @keyframes scan-animation {
            0% {
                top: 0;
            }
            100% {
                top: 100%;
            }
        }
        
        .btn-primary {
            background-color: #0066cc;
            color: white;
            border-radius: 12px;
            font-weight: 600;
            padding: 12px 20px;
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 102, 204, 0.25);
        }
        
        .btn-primary:hover {
            background-color: #004c99;
            transform: translateY(-1px);
            box-shadow: 0 6px 8px rgba(0, 102, 204, 0.3);
        }
        
        .btn-primary:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0, 102, 204, 0.2);
        }
        
        .btn-secondary {
            background-color: #f1f5f9;
            color: #334155;
            border-radius: 12px;
            font-weight: 600;
            padding: 12px 20px;
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .btn-secondary:hover {
            background-color: #e2e8f0;
            transform: translateY(-1px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.08);
        }
        
        .btn-secondary:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
        }
        
        .card {
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.03);
            background-color: white;
            overflow: hidden;
        }
        
        .preview-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 12px;
            background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 100%);
            color: white;
            font-weight: 500;
        }
        
        .scanning-animation {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(to right, transparent, #0066cc, transparent);
            animation: scan 1.5s ease-in-out infinite;
            opacity: 0.8;
        }
        
        @keyframes scan {
            0% {
                top: 0;
            }
            100% {
                top: 100%;
            }
        }
        
        /* Table styles */
        .results-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .results-table th {
            background-color: #f8fafc;
            text-transform: uppercase;
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .results-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .results-table tr:last-child td {
            border-bottom: none;
        }
        
        .results-table tr:nth-child(even) {
            background-color: #f8fafc;
        }
        
        /* Chatbot styles */
        .chatbot-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 30px;
            background-color: #0066cc;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 50;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .chatbot-button:hover {
            transform: scale(1.05);
        }
        
        .chatbot-container {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 350px;
            height: 450px;
            border-radius: 16px;
            background-color: white;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 50;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            transform-origin: bottom right;
        }
        
        .chatbot-header {
            background-color: #0066cc;
            padding: 15px;
            color: white;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chatbot-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            margin-bottom: 5px;
            word-wrap: break-word;
        }
        
        .user-message {
            background-color: #0066cc;
            color: white;
            border-bottom-right-radius: 5px;
            align-self: flex-end;
        }
        
        .bot-message {
            background-color: #f1f5f9;
            color: #1e293b;
            border-bottom-left-radius: 5px;
            align-self: flex-start;
        }
        
        .chatbot-input {
            padding: 15px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
        }
        
        .chatbot-input input {
            flex: 1;
            padding: 10px 15px;
            border-radius: 30px;
            border: 1px solid #e2e8f0;
            outline: none;
            font-size: 14px;
        }
        
        .chatbot-input button {
            background-color: #0066cc;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .chatbot-input button:hover {
            background-color: #004c99;
        }
        
        .hidden-scale {
            transform: scale(0);
            pointer-events: none;
            opacity: 0;
        }
        
        /* Loading spinner */
        .spinner {
            border: 3px solid rgba(0, 102, 204, 0.2);
            border-top: 3px solid #0066cc;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin-left: auto;
            margin-right: auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Slide transitions */
        .slide-section {
            transition: all 0.3s ease-in-out;
        }
        
        .slide-enter {
            transform: translateX(100%);
            opacity: 0;
        }
        
        .slide-exit {
            transform: translateX(-100%);
            opacity: 0;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="app-container">
        <!-- App Header -->
        <header class="sticky top-0 z-10 bg-white shadow-soft px-4 py-3 flex justify-between items-center">
            <div class="flex items-center">
                <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center text-white mr-3">
                    <i class="fas fa-id-card text-lg"></i>
                </div>
                <h1 class="text-xl font-bold text-neutral-darkest">DriverLicenseScanner</h1>
            </div>
            <button id="help-button" class="w-10 h-10 rounded-full flex items-center justify-center text-neutral-dark hover:bg-neutral-lighter">
                <i class="fas fa-question-circle text-xl"></i>
            </button>
        </header>
        
        <!-- Welcome Screen -->
        <section id="welcome-section" class="p-5 flex flex-col flex-grow">
            <div class="card p-6 mb-6 text-center">
                <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-primary-light/20 flex items-center justify-center">
                    <i class="fas fa-id-card text-3xl text-primary"></i>
                </div>
                <h2 class="text-2xl font-bold text-neutral-darkest mb-2">License Scanner</h2>
                <p class="text-neutral-dark mb-6">Quickly extract information from your driver's license in seconds</p>
                <button id="start-scanning" class="btn-primary">
                    <i class="fas fa-camera mr-2"></i> Start Scanning
                </button>
            </div>
        </section>
        
        <!-- Camera Section -->
        <section id="camera-section" class="hidden slide-section slide-enter flex flex-col flex-grow">
            <div class="relative flex-col">
                <div class="absolute top-0 left-0 right-0 bg-gradient-to-b from-black/50 to-transparent p-4 z-10">
                    <div class="flex justify-between">
                        <button id="camera-back" class="w-10 h-10 rounded-full bg-black/30 backdrop-blur-sm flex items-center justify-center text-white">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button id="camera-toggle-flash" class="w-10 h-10 rounded-full bg-black/30 backdrop-blur-sm flex items-center justify-center text-white">
                            <i class="fas fa-bolt"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Camera container with improved dimensions -->
                <div class="camera-container bg-black">
                    <video id="video" class="camera-view" autoplay playsinline></video>
                    
                    <div class="scanner-container">
                        <div id="scanner-frame" class="scanner-frame">
                            <!-- Corner elements -->
                            <div class="corner corner-top-left"></div>
                            <div class="corner corner-top-right"></div>
                            <div class="corner corner-bottom-left"></div>
                            <div class="corner corner-bottom-right"></div>
                            
                            <!-- Scan animation line -->
                            <div class="scan-line"></div>
                            
                            <!-- Guide lines to help position license -->
                            <div class="scanner-guide-lines">
                                <div class="guide-line guide-line-h top"></div>
                                <div class="guide-line guide-line-h bottom"></div>
                                <div class="guide-line guide-line-v left"></div>
                                <div class="guide-line guide-line-v right"></div>
                            </div>
                            
                            <!-- Scan instruction (moved from status indicator) -->
                            <div class="scan-instruction">
                                <i class="fas fa-id-card mr-1"></i> Position license within frame
                            </div>
                        </div>
                    </div>
                    
                    <div class="absolute bottom-5 left-0 right-0 flex justify-center">
                        <div class="px-4 py-2 rounded-full bg-white/90 backdrop-blur-sm text-sm font-medium text-neutral-dark shadow-lg">
                            <i class="fas fa-id-card mr-1 text-primary"></i>
                            Center your license in the frame
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-4 shadow-lg">
                    <button id="capture-button" class="btn-primary flex items-center justify-center mx-auto my-2">
                        <i class="fas fa-camera mr-2"></i> Capture License
                    </button>
                    
                    <div class="mt-4 bg-blue-50 rounded-lg p-3 text-sm">
                        <div class="font-medium text-primary-dark mb-1">Tips for best results:</div>
                        <ul class="text-neutral-darker space-y-1">
                            <li class="flex items-center">
                                <i class="fas fa-check-circle text-primary mr-2"></i>
                                Good lighting, avoid glare
                            </li>
                            <li class="flex items-center">
                                <i class="fas fa-check-circle text-primary mr-2"></i>
                                Keep license flat inside frame
                            </li>
                            <li class="flex items-center">
                                <i class="fas fa-check-circle text-primary mr-2"></i>
                                Hold camera steady
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Preview Section -->
        <section id="preview-section" class="hidden slide-section slide-enter p-4 flex flex-col flex-grow">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-bold text-neutral-darkest">Review Image</h2>
                <button id="preview-back" class="text-neutral-dark">
                    <i class="fas fa-arrow-left mr-1"></i> Back
                </button>
            </div>
            
            <div class="flex flex-col items-center justify-center flex-grow">
                <div class="preview-card">
                    <canvas id="canvas" class="w-full h-full"></canvas>
                    <div class="preview-overlay">
                        <div class="flex items-center">
                            <i class="fas fa-id-card mr-2"></i>
                            Driver's License
                        </div>
                    </div>
                </div>
                
                <div class="w-full max-w-md space-y-3 mt-4">
                    <button id="extract-button" class="btn-primary flex items-center justify-center w-full mx-auto">
                        <i class="fas fa-magic mr-2"></i> Extract Information
                    </button>
                    
                    <button id="retake-button" class="btn-secondary flex items-center justify-center w-full mx-auto">
                        <i class="fas fa-redo mr-2"></i> Retake Photo
                    </button>
                </div>
            </div>
        </section>
        
        <!-- Feedback Section -->
        <section id="feedback-section" class="hidden slide-section slide-enter p-5 flex flex-col flex-grow">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-neutral-darkest">Image Analysis</h2>
            </div>
            
            <div class="card p-5 mb-5">
                <div class="w-16 h-16 mx-auto mb-3 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600">
                    <i class="fas fa-exclamation-triangle text-2xl feedback-icon"></i>
                </div>
                
                <h3 id="feedback-title" class="text-lg font-bold text-center text-neutral-darkest mb-2">
                    We found some issues
                </h3>
                
                <p id="feedback-message" class="text-center text-neutral-dark mb-4">
                    The license image could be improved for better results.
                </p>
                
                <div class="bg-yellow-50 rounded-lg p-4 mb-4">
                    <h4 class="font-semibold text-neutral-darker mb-2">Suggestions:</h4>
                    <ul id="feedback-suggestions" class="text-sm text-neutral-dark space-y-2">
                        <!-- Suggestions will be added here -->
                    </ul>
                </div>
            </div>
            
            <div class="space-y-3">
                <button id="retry-camera" class="btn-primary w-full flex items-center justify-center">
                    <i class="fas fa-camera mr-2"></i> Retake Photo
                </button>
                
                <button id="force-extract" class="btn-secondary w-full flex items-center justify-center">
                    <i class="fas fa-magic mr-2"></i> Try Anyway
                </button>
            </div>
        </section>
        
        <!-- Loading Section -->
        <section id="loading-section" class="hidden slide-section slide-enter p-5 flex flex-col flex-grow items-center justify-center">
            <div class="card p-8 w-full max-w-sm flex flex-col items-center">
                <div class="relative w-20 h-20 mb-6">
                    <div class="absolute inset-0 rounded-full border-4 border-neutral-light"></div>
                    <div class="absolute inset-0 rounded-full border-4 border-transparent border-t-primary animate-spin"></div>
                </div>
                
                <h3 class="text-lg font-bold text-neutral-darkest mb-2">Processing License</h3>
                <p id="loading-message" class="text-neutral-dark text-center">Analyzing image...</p>
                
                <div class="w-full mt-6 bg-neutral-lighter rounded-full h-2 overflow-hidden">
                    <div id="progress-bar" class="bg-primary h-full rounded-full" style="width: 0%"></div>
                </div>
            </div>
        </section>
        
        <!-- Results Section with Table Format -->
        <section id="results-section" class="hidden slide-section slide-enter p-4 flex flex-col flex-grow">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-bold text-neutral-darkest">License Information</h2>
                <button id="results-back" class="text-neutral-dark">
                    <i class="fas fa-times mr-1"></i> Close
                </button>
            </div>
            
            <div class="bg-white rounded-lg shadow-soft p-4 mb-2 overflow-hidden">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-semibold text-neutral-darker">Extracted Data</h3>
                    <div id="accuracy-badge" class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-800 font-medium">
                        <i class="fas fa-check-circle mr-1"></i> High Accuracy
                    </div>
                </div>
                
                <!-- Table format for results -->
                <div class="overflow-x-auto">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th class="w-1/3">Field</th>
                                <th class="w-2/3">Value</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body">
                            <!-- Results will be added here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="mt-2 p-3 bg-neutral-lighter rounded-lg text-xs text-neutral-dark">
                <div id="timing-info">Processing time: 2.4s</div>
            </div>
            
            <div class="mt-auto pt-4 space-y-3">
                <button id="copy-table" class="btn-primary flex items-center justify-center mx-auto">
                    <i class="fas fa-table mr-2"></i> Copy Table Data
                </button>
                
                <button id="new-scan" class="btn-secondary flex items-center justify-center mx-auto">
                    <i class="fas fa-redo mr-2"></i> Scan Another License
                </button>
                
                <button id="toggle-raw" class="text-sm text-neutral-dark flex items-center justify-center py-2 mx-auto">
                    <i class="fas fa-code mr-2"></i> Toggle Raw Data
                </button>
            </div>
            
            <div id="raw-section" class="mt-4 hidden">
                <div class="bg-neutral-lightest rounded-lg p-3 border border-neutral-light">
                    <div class="text-xs font-medium text-neutral-dark mb-1">Raw Extracted Text:</div>
                    <pre id="raw-text" class="text-xs text-neutral-darker overflow-x-auto whitespace-pre-wrap"></pre>
                </div>
            </div>
        </section>
        
        <!-- Help Overlay -->
        <div id="help-overlay" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-5">
            <div class="bg-white rounded-xl max-w-md w-full max-h-[80vh] overflow-auto">
                <div class="p-5 border-b border-neutral-light">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-bold text-neutral-darkest">How to Use DriverLicenseScanner</h2>
                        <button id="close-help" class="text-neutral-dark w-8 h-8 flex items-center justify-center rounded-full hover:bg-neutral-lighter">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div class="p-5 space-y-4">
                    <div>
                        <h3 class="font-semibold text-neutral-darker flex items-center">
                            <div class="w-6 h-6 rounded-full bg-primary-light/20 flex items-center justify-center text-primary mr-2">1</div>
                            Position Your License
                        </h3>
                        <p class="text-sm text-neutral-dark mt-1 ml-8">
                            Place your driver's license within the frame. Make sure all four corners are visible.
                        </p>
                    </div>
                    
                    <div>
                        <h3 class="font-semibold text-neutral-darker flex items-center">
                            <div class="w-6 h-6 rounded-full bg-primary-light/20 flex items-center justify-center text-primary mr-2">2</div>
                            Capture the Image
                        </h3>
                        <p class="text-sm text-neutral-dark mt-1 ml-8">
                            Press the "Capture License" button when the license is properly positioned.
                        </p>
                    </div>
                    
                    <div>
                        <h3 class="font-semibold text-neutral-darker flex items-center">
                            <div class="w-6 h-6 rounded-full bg-primary-light/20 flex items-center justify-center text-primary mr-2">3</div>
                            Review and Extract
                        </h3>
                        <p class="text-sm text-neutral-dark mt-1 ml-8">
                            Check the preview and press "Extract Information" to process the license.
                        </p>
                    </div>
                    
                    <div>
                        <h3 class="font-semibold text-neutral-darker flex items-center">
                            <div class="w-6 h-6 rounded-full bg-primary-light/20 flex items-center justify-center text-primary mr-2">4</div>
                            View Results
                        </h3>
                        <p class="text-sm text-neutral-dark mt-1 ml-8">
                            The app will extract all available information from your license and display it in an organized format.
                        </p>
                    </div>
                    
                    <div class="pt-2">
                        <h3 class="font-semibold text-neutral-darker">Tips for Best Results:</h3>
                        <ul class="text-sm text-neutral-dark mt-2 space-y-2">
                            <li class="flex items-start">
                                <i class="fas fa-check-circle text-primary mt-0.5 mr-2"></i>
                                <span>Use good lighting â€“ avoid glare and shadows</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-check-circle text-primary mt-0.5 mr-2"></i>
                                <span>Keep your license flat and centered in the frame</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-check-circle text-primary mt-0.5 mr-2"></i>
                                <span>If you get quality feedback, follow the suggestions</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-check-circle text-primary mt-0.5 mr-2"></i>
                                <span>Use a plain, contrasting background if possible</span>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <div class="p-5 border-t border-neutral-light">
                    <button id="help-got-it" class="btn-primary w-full">Got it!</button>
                </div>
            </div>
        </div>
        
        <!-- Error Alert -->
        <div id="error-alert" class="hidden fixed bottom-5 left-5 right-5 bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="bg-red-500 h-1"></div>
            <div class="p-4">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-circle text-xl text-red-500"></i>
                    </div>
                    <div class="ml-3 w-0 flex-1">
                        <h3 id="error-title" class="text-sm font-medium text-neutral-darkest">Error occurred</h3>
                        <p id="error-message" class="mt-1 text-sm text-neutral-dark">Something went wrong. Please try again.</p>
                    </div>
                    <div class="ml-4 flex-shrink-0 flex">
                        <button id="dismiss-error" class="inline-flex text-neutral-dark hover:text-neutral-darkest">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chatbot Button -->
        <div id="chatbot-button" class="chatbot-button">
            <i class="fas fa-comment-dots text-white text-2xl"></i>
        </div>
        
        <!-- Chatbot Container -->
        <div id="chatbot-container" class="chatbot-container hidden-scale">
            <div class="chatbot-header">
                <span>License Assistant</span>
                <button id="close-chatbot" class="text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="chatbot-messages" class="chatbot-messages">
                <div class="message bot-message">
                    Hi there! I'm your license assistant. How can I help you with your driver's license information?
                </div>
            </div>
            <div class="chatbot-input">
                <input type="text" id="chatbot-input-field" placeholder="Ask a question about your license...">
                <button id="chatbot-send">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
    // Sections
    const welcomeSection = document.getElementById('welcome-section');
    const cameraSection = document.getElementById('camera-section');
    const previewSection = document.getElementById('preview-section');
    const loadingSection = document.getElementById('loading-section');
    const resultsSection = document.getElementById('results-section');
    const feedbackSection = document.getElementById('feedback-section');
    const rawSection = document.getElementById('raw-section');
    const helpOverlay = document.getElementById('help-overlay');
    const errorAlert = document.getElementById('error-alert');
    const chatbotContainer = document.getElementById('chatbot-container');
    
    // Elements
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const scannerFrame = document.getElementById('scanner-frame');
    const loadingMessage = document.getElementById('loading-message');
    const progressBar = document.getElementById('progress-bar');
    const resultsTableBody = document.getElementById('results-table-body');
    const rawText = document.getElementById('raw-text');
    const timingInfo = document.getElementById('timing-info');
    const feedbackTitle = document.getElementById('feedback-title');
    const feedbackMessage = document.getElementById('feedback-message');
    const feedbackSuggestions = document.getElementById('feedback-suggestions');
    const errorTitle = document.getElementById('error-title');
    const errorMessageElem = document.getElementById('error-message');
    const chatbotMessages = document.getElementById('chatbot-messages');
    const chatbotInputField = document.getElementById('chatbot-input-field');
    
    // Buttons
    const startScanningBtn = document.getElementById('start-scanning');
    const cameraBackBtn = document.getElementById('camera-back');
    const cameraToggleFlashBtn = document.getElementById('camera-toggle-flash');
    const captureButton = document.getElementById('capture-button');
    const previewBackBtn = document.getElementById('preview-back');
    const extractButton = document.getElementById('extract-button');
    const retakeButton = document.getElementById('retake-button');
    const retryCamera = document.getElementById('retry-camera');
    const forceExtract = document.getElementById('force-extract');
    const resultsBackBtn = document.getElementById('results-back');
    const copyTableBtn = document.getElementById('copy-table');
    const newScanBtn = document.getElementById('new-scan');
    const toggleRawBtn = document.getElementById('toggle-raw');
    const helpButton = document.getElementById('help-button');
    const closeHelpBtn = document.getElementById('close-help');
    const helpGotItBtn = document.getElementById('help-got-it');
    const dismissErrorBtn = document.getElementById('dismiss-error');
    const chatbotButton = document.getElementById('chatbot-button');
    const closeChatbotBtn = document.getElementById('close-chatbot');
    const chatbotSendBtn = document.getElementById('chatbot-send');
    
    // State variables
    let stream = null;
    let flashEnabled = false;
    let capturedImageData = null;
    let extractedData = null;
    let rawExtractedText = '';
    let processedLicenseText = '';
    let capturedImageDimensions = { width: 0, height: 0 };
    
    // Scanner frame dimensions
    let scannerBoundingBox = { relX: 0, relY: 0, relWidth: 0, relHeight: 0 };
    
    // Debug logger
    function log(message, type = 'info') {
        const timestamp = new Date().toISOString();
        
        // Also log to browser console
        if (type === 'error') {
            console.error(`[${timestamp}] ${message}`);
        } else if (type === 'warn') {
            console.warn(`[${timestamp}] ${message}`);
        } else {
            console.log(`[${timestamp}] ${message}`);
        }
    }
    
    // Show/hide sections with animation
    function showSection(section) {
        // Hide all sections
        [welcomeSection, cameraSection, previewSection, loadingSection, 
         resultsSection, feedbackSection].forEach(s => {
            if (s !== section && !s.classList.contains('hidden')) {
                s.classList.add('slide-exit');
                setTimeout(() => {
                    s.classList.add('hidden');
                    s.classList.remove('slide-exit');
                }, 300);
            }
        });
        
        // Show target section
        if (section.classList.contains('hidden')) {
            section.classList.add('slide-enter');
            section.classList.remove('hidden');
            
            // Trigger reflow to ensure transition happens
            section.offsetHeight;
            
            setTimeout(() => {
                section.classList.remove('slide-enter');
            }, 10);
        }
    }
    
    // Show error alert
    function showError(title, message) {
        errorTitle.textContent = title;
        errorMessageElem.textContent = message;
        errorAlert.classList.remove('hidden');
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            errorAlert.classList.add('hidden');
        }, 5000);
        
        log(`Error: ${title} - ${message}`, 'error');
    }
    
    // Helper function to stop camera
    function stopCamera() {
        if (stream) {
            log('Stopping camera stream', 'debug');
            stream.getTracks().forEach(track => {
                track.stop();
            });
            stream = null;
        }
    }
    
    // Initialize scanner frame dimensions
    function initScannerFrame() {
        if (!scannerFrame) return;
        
        // Get the dimensions of the scanner frame from the DOM element
        const rect = scannerFrame.getBoundingClientRect();
        
        // Calculate relative position within the video
        const videoContainer = document.querySelector('.camera-container');
        if (!videoContainer) return;
        
        const videoRect = videoContainer.getBoundingClientRect();
        
        // Calculate relative coordinates (0-1 range)
        const relX = (rect.left - videoRect.left) / videoRect.width;
        const relY = (rect.top - videoRect.top) / videoRect.height;
        const relWidth = rect.width / videoRect.width;
        const relHeight = rect.height / videoRect.height;
        
        // Store relative dimensions for later use with actual video dimensions
        scannerBoundingBox = {
            relX: Math.max(0, relX),
            relY: Math.max(0, relY),
            relWidth: Math.min(1, relWidth),
            relHeight: Math.min(1, relHeight)
        };
        
        log(`Scanner frame initialized with dimensions: ${JSON.stringify(scannerBoundingBox)}`);
    }
    
    // Improved camera initialization with proper dimensions
    async function initCamera() {
        try {
            // Get device orientation and aspect ratio
            const isPortrait = window.innerHeight > window.innerWidth;
            
            const constraints = { 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: isPortrait ? 720 : 1280 },
                    height: { ideal: isPortrait ? 1280 : 720 }
                } 
            };
            
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;
            
            // Reset flash state
            flashEnabled = false;
            cameraToggleFlashBtn.innerHTML = '<i class="fas fa-bolt"></i>';
            
            // Show camera section
            showSection(cameraSection);
            
            // Initialize scanner frame dimensions after camera loaded
            video.addEventListener('loadedmetadata', () => {
                // Short delay to ensure UI has rendered
                setTimeout(initScannerFrame, 300);
            });
            
            log('Camera initialized successfully');
        } catch (err) {
            log(`Camera initialization error: ${err.message}`, 'error');
            showError('Camera Error', 'Could not access the camera. Please ensure you have granted camera permissions.');
            showSection(welcomeSection);
        }
    }
    
    // Enhanced capture image function
    function captureImage() {
        try {
            const context = canvas.getContext('2d');
            
            // Get the video dimensions
            const videoWidth = video.videoWidth;
            const videoHeight = video.videoHeight;
            
            // Calculate absolute dimensions of scanner area based on video size
            const cropX = Math.floor(scannerBoundingBox.relX * videoWidth);
            const cropY = Math.floor(scannerBoundingBox.relY * videoHeight);
            const cropWidth = Math.floor(scannerBoundingBox.relWidth * videoWidth);
            const cropHeight = Math.floor(scannerBoundingBox.relHeight * videoHeight);
            
            // Set canvas dimensions to match the cropped area
            canvas.width = cropWidth;
            canvas.height = cropHeight;
            
            // Draw only the scanner frame area to canvas
            context.drawImage(
                video,
                cropX, cropY, cropWidth, cropHeight,  // Source rectangle
                0, 0, cropWidth, cropHeight           // Destination rectangle
            );
            
            // Get image data as base64
            capturedImageData = canvas.toDataURL('image/jpeg', 0.95).split(',')[1];
            
            // Store cropped dimensions for reference
            capturedImageDimensions = {
                width: cropWidth,
                height: cropHeight
            };
            
            // Log capture info
            log(`Captured image from scanner frame. Crop area: (${cropX},${cropY},${cropWidth},${cropHeight})`);
            
            // Stop camera
            stopCamera();
            
            // Show preview section
            showSection(previewSection);
            
            log('Image captured successfully');
            return true;
        } catch (err) {
            log(`Image capture error: ${err.message}`, 'error');
            showError('Capture Error', 'Failed to capture image. Please try again.');
            return false;
        }
    }
    
    // Process image extraction
    async function processExtraction(imageData, forceExtraction = false) {
        // Show loading section
        showSection(loadingSection);
        
        // Animate progress bar
        progressBar.style.width = '0%';
        let progress = 0;
        const progressInterval = setInterval(() => {
            if (progress < 90) {
                progress += Math.random() * 5;
                progressBar.style.width = `${progress}%`;
                
                // Update loading message based on progress
                if (progress < 20) {
                    loadingMessage.textContent = 'Enhancing image quality...';
                } else if (progress < 40) {
                    loadingMessage.textContent = 'Detecting license boundaries...';
                } else if (progress < 60) {
                    loadingMessage.textContent = 'Extracting text...';
                } else {
                    loadingMessage.textContent = 'Processing license information...';
                }
            }
        }, 300);
        
        try {
            // Prepare enhanced request with pre-processing options
            const requestBody = {
                image: imageData,
                options: {
                    enhance_quality: true,   // Request server-side image enhancement
                    detect_boundaries: true, // Request license boundary detection
                    auto_crop: true,         // Request automatic cropping
                    correct_perspective: true // Request perspective correction
                }
            };
            
            if (forceExtraction) {
                requestBody.force_extraction = true;
            }
            
            const response = await fetch('/extract', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody),
            });
            
            const result = await response.json();
            
            // Clear progress interval
            clearInterval(progressInterval);
            progressBar.style.width = '100%';
            
            if (result.status === 'error') {
                // Check if we received analysis feedback
                if (result.analysis) {
                    handleImageFeedback(result.analysis, result.suggestions);
                } else {
                    // General error
                    throw new Error(result.message || "Unknown error occurred");
                }
            } else if (result.status === 'success') {
                // Store extracted data
                extractedData = result.data || {};
                rawExtractedText = result.raw_text || '';
                processedLicenseText = result.license_info || '';
                
                // Update raw text display
                rawText.textContent = rawExtractedText;
                
                // Clear previous results
                resultsTableBody.innerHTML = '';
                
                // Add results to table
                Object.entries(extractedData).forEach(([key, value]) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="font-medium">${key}</td>
                        <td>${value}</td>
                    `;
                    resultsTableBody.appendChild(row);
                });
                
                // Update timing info if available
                if (result.processing_time) {
                    const timing = result.processing_time;
                    timingInfo.innerHTML = `
                        <strong>Processing:</strong> ${timing.total_time || 'N/A'} | 
                        Analysis: ${timing.identification_time || 'N/A'} | 
                        Extraction: ${timing.extraction_time || 'N/A'}
                    `;
                }
                
                // Set accuracy badge based on result count
                const accuracyBadge = document.getElementById('accuracy-badge');
                const resultCount = Object.keys(extractedData).length;
                
                if (resultCount >= 7) {
                    accuracyBadge.innerHTML = '<i class="fas fa-check-circle mr-1"></i> High Accuracy';
                    accuracyBadge.className = 'text-xs px-2 py-1 rounded-full bg-green-100 text-green-800 font-medium';
                } else if (resultCount >= 4) {
                    accuracyBadge.innerHTML = '<i class="fas fa-check-circle mr-1"></i> Medium Accuracy';
                    accuracyBadge.className = 'text-xs px-2 py-1 rounded-full bg-yellow-100 text-yellow-800 font-medium';
                } else {
                    accuracyBadge.innerHTML = '<i class="fas fa-exclamation-circle mr-1"></i> Low Accuracy';
                    accuracyBadge.className = 'text-xs px-2 py-1 rounded-full bg-red-100 text-red-800 font-medium';
                }
                
                // Show results section
                showSection(resultsSection);
            }
        } catch (err) {
            // Clear progress interval
            clearInterval(progressInterval);
            
            log(`Extraction error: ${err.message}`, 'error');
            showError('Processing Error', 'Failed to process the image. Please try again.');
            showSection(previewSection);
        }
    }
    
    // Handle image feedback
    function handleImageFeedback(analysis, suggestions) {
        log(`Processing image feedback: ${JSON.stringify(analysis)}`, 'debug');
        
        feedbackTitle.textContent = analysis.license_detected 
            ? "Image Quality Issues"
            : "No License Detected";
        
        feedbackMessage.textContent = analysis.license_detected 
            ? "We detected some issues with the license image."
            : "We couldn't clearly detect a driver's license in the image.";
        
        // Clear previous suggestions
        feedbackSuggestions.innerHTML = '';
        
        // Add suggestions
        const suggestionsList = suggestions || analysis.improvement_suggestions || [];
        suggestionsList.forEach(suggestion => {
            const li = document.createElement('li');
            li.className = 'flex items-start';
            li.innerHTML = `
                <i class="fas fa-info-circle text-yellow-600 mt-0.5 mr-2"></i>
                <span>${suggestion}</span>
            `;
            feedbackSuggestions.appendChild(li);
        });
        
        // If no suggestions were provided but there are issues
        if (suggestionsList.length === 0 && analysis.issues && analysis.issues.length > 0) {
            const defaultSuggestions = [
                "Make sure the license fills most of the frame",
                "Ensure good lighting with no glare",
                "Use a plain background",
                "Hold the camera steady"
            ];
            
            defaultSuggestions.forEach(suggestion => {
                const li = document.createElement('li');
                li.className = 'flex items-start';
                li.innerHTML = `
                    <i class="fas fa-info-circle text-yellow-600 mt-0.5 mr-2"></i>
                    <span>${suggestion}</span>
                `;
                feedbackSuggestions.appendChild(li);
            });
        }
        
        // Show feedback section
        showSection(feedbackSection);
    }
    
    // Copy table data to clipboard
    function copyTableData() {
        if (!extractedData) {
            showError('Copy Failed', 'No data to copy');
            return;
        }
        
        try {
            // Create a formatted text table
            let tableText = '';
            
            // Add headers
            tableText += 'Field\tValue\n';
            tableText += '----------------\t----------------\n';
            
            // Add data rows
            Object.entries(extractedData).forEach(([key, value]) => {
                tableText += `${key}\t${value}\n`;
            });
            
            // Copy to clipboard
            navigator.clipboard.writeText(tableText)
                .then(() => {
                    // Show brief feedback
                    const originalText = copyTableBtn.textContent;
                    copyTableBtn.innerHTML = '<i class="fas fa-check mr-2"></i> Copied!';
                    setTimeout(() => {
                        copyTableBtn.innerHTML = '<i class="fas fa-table mr-2"></i> Copy Table Data';
                    }, 1500);
                })
                .catch(err => {
                    showError('Copy Failed', 'Could not copy to clipboard');
                });
        } catch (err) {
            showError('Copy Failed', 'Could not copy to clipboard');
        }
    }
    
    // Chatbot functions
    function toggleChatbot() {
        chatbotContainer.classList.toggle('hidden-scale');
        
        // Focus the input field when opening
        if (!chatbotContainer.classList.contains('hidden-scale')) {
            setTimeout(() => {
                chatbotInputField.focus();
            }, 300);
        }
    }
    
    function addChatMessage(message, isUser = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
        messageDiv.textContent = message;
        
        chatbotMessages.appendChild(messageDiv);
        
        // Scroll to the bottom
        chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
    }
    
    function processChatbotQuestion(question) {
        // Clear the input field
        chatbotInputField.value = '';
        
        // Add the user question to the chat
        addChatMessage(question, true);
        
        // Show a loading indicator
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'message bot-message';
        loadingDiv.innerHTML = '<div class="spinner"></div>';
        chatbotMessages.appendChild(loadingDiv);
        
        // Scroll to the bottom
        chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        
        // Process the question (normally this would be an API call)
        setTimeout(() => {
            // Remove loading indicator
            chatbotMessages.removeChild(loadingDiv);
            
            // Get answer based on the extracted license data
            const answer = getChatbotResponse(question);
            
            // Add the bot response
            addChatMessage(answer);
        }, 1000);
    }
    
    function getChatbotResponse(question) {
        // Check if we have extracted data
        if (!extractedData || Object.keys(extractedData).length === 0) {
            return "I don't have any license information yet. Please scan a license first, then I can help answer questions about it.";
        }
        
        // Convert question to lowercase for easier matching
        const q = question.toLowerCase();
        
        // Check for license number questions
        if (q.includes('license number') || q.includes('lic#') || q.includes('id number')) {
            const licenseNumber = extractedData['LIC#'] || extractedData['License Number'];
            if (licenseNumber) {
                return `The license number is ${licenseNumber}.`;
            } else {
                return "I couldn't find a license number in the scanned data.";
            }
        }
        
        // Check for expiration date questions
        if (q.includes('expire') || q.includes('expiration') || q.includes('valid until')) {
            const expirationDate = extractedData['Expiration Date'];
            if (expirationDate) {
                return `The license expires on ${expirationDate}.`;
            } else {
                return "I couldn't find an expiration date in the scanned data.";
            }
        }
        
        // Check for name questions
        if (q.includes('name') || q.includes('whose') || q.includes('who')) {
            const name = extractedData['Name'];
            if (name) {
                return `The name on the license is ${name}.`;
            } else {
                return "I couldn't find a name in the scanned data.";
            }
        }
        
        // Check for address questions
        if (q.includes('address') || q.includes('live') || q.includes('location') || q.includes('residence')) {
            const address = extractedData['Address'];
            if (address) {
                return `The address on the license is ${address}.`;
            } else {
                return "I couldn't find an address in the scanned data.";
            }
        }
        
        // Check for DOB questions
        if (q.includes('birth') || q.includes('born') || q.includes('dob') || q.includes('age')) {
            const dob = extractedData['DOB'];
            if (dob) {
                return `The date of birth is ${dob}.`;
            } else {
                return "I couldn't find a date of birth in the scanned data.";
            }
        }
        
        // Check for physical characteristics
        if (q.includes('height') || q.includes('tall')) {
            const height = extractedData['Height'];
            if (height) {
                return `The height listed on the license is ${height}.`;
            } else {
                return "I couldn't find height information in the scanned data.";
            }
        }
        
        if (q.includes('weight')) {
            const weight = extractedData['Weight'];
            if (weight) {
                return `The weight listed on the license is ${weight}.`;
            } else {
                return "I couldn't find weight information in the scanned data.";
            }
        }
        
        if (q.includes('eye') || q.includes('eyes')) {
            const eyes = extractedData['Eyes'];
            if (eyes) {
                return `The eye color listed on the license is ${eyes}.`;
            } else {
                return "I couldn't find eye color information in the scanned data.";
            }
        }
        
        if (q.includes('sex') || q.includes('gender')) {
            const sex = extractedData['Sex'];
            if (sex) {
                return `The sex listed on the license is ${sex}.`;
            } else {
                return "I couldn't find sex/gender information in the scanned data.";
            }
        }
        
        // Check for restrictions
        if (q.includes('restriction') || q.includes('restricted') || q.includes('limitation')) {
            const restrictions = extractedData['Restrictions'];
            if (restrictions) {
                return `The license has the following restrictions: ${restrictions}.`;
            } else {
                return "I couldn't find any restriction information in the scanned data.";
            }
        }
        
        // Check for class
        if (q.includes('class') || q.includes('type')) {
            const licenseClass = extractedData['Class'];
            if (licenseClass) {
                return `This is a Class ${licenseClass} license.`;
            } else {
                return "I couldn't find license class information in the scanned data.";
            }
        }
        
        // Check for donor status
        if (q.includes('donor') || q.includes('donation') || q.includes('organ')) {
            const donor = extractedData['Donor'];
            if (donor) {
                return `Donor status: ${donor}.`;
            } else {
                return "I couldn't find donor status information in the scanned data.";
            }
        }
        
        // Check for issue date
        if (q.includes('issue') || q.includes('issued') || q.includes('when got')) {
            const issueDate = extractedData['Issue Date'];
            if (issueDate) {
                return `The license was issued on ${issueDate}.`;
            } else {
                return "I couldn't find the issue date in the scanned data.";
            }
        }
        
        // General questions about what was found
        if (q.includes('what did you find') || q.includes('what information') || q.includes('what data')) {
            const fields = Object.keys(extractedData);
            if (fields.length > 0) {
                return `I found the following information: ${fields.join(', ')}.`;
            } else {
                return "I couldn't find any information in the scanned license.";
            }
        }
        
        // Fallback response
        return "I'm not sure about that. I can help with questions about the license information like name, expiration date, address, etc.";
    }
    
    // Simulated license detection (in a real app, would use ML)
    function simulateLicenseDetection() {
        if (!video.srcObject) return;
        
        // Start mock license detection
        const detectionInterval = setInterval(() => {
            if (!video.srcObject) {
                clearInterval(detectionInterval);
                return;
            }
        }, 1500);
        
        // Store interval ID for cleanup
        video.dataset.detectionInterval = detectionInterval;
    }
    
    // Event listeners
    startScanningBtn.addEventListener('click', initCamera);
    
    cameraBackBtn.addEventListener('click', () => {
        stopCamera();
        showSection(welcomeSection);
    });
    
    cameraToggleFlashBtn.addEventListener('click', () => {
        if (stream) {
            const track = stream.getVideoTracks()[0];
            
            // Check if torch is supported
            if (track.getCapabilities && track.getCapabilities().torch) {
                flashEnabled = !flashEnabled;
                track.applyConstraints({
                    advanced: [{ torch: flashEnabled }]
                });
                
                // Update button icon
                cameraToggleFlashBtn.innerHTML = flashEnabled 
                    ? '<i class="fas fa-bolt text-yellow-400"></i>' 
                    : '<i class="fas fa-bolt"></i>';
            } else {
                showError('Not Supported', 'Flash/torch is not supported on this device');
            }
        }
    });
    
    captureButton.addEventListener('click', captureImage);
    
    previewBackBtn.addEventListener('click', () => {
        initCamera(); // Reopen camera
    });
    
    extractButton.addEventListener('click', () => {
        processExtraction(capturedImageData);
    });
    
    retakeButton.addEventListener('click', () => {
        initCamera(); // Reopen camera
    });
    
    retryCamera.addEventListener('click', () => {
        initCamera(); // Reopen camera from feedback
    });
    
    forceExtract.addEventListener('click', () => {
        processExtraction(capturedImageData, true); // Force extraction
    });
    
    resultsBackBtn.addEventListener('click', () => {
        showSection(welcomeSection);
    });
    
    copyTableBtn.addEventListener('click', copyTableData);
    
    newScanBtn.addEventListener('click', () => {
        // Reset state and go to welcome
        rawSection.classList.add('hidden');
        initCamera();
    });
    
    toggleRawBtn.addEventListener('click', () => {
        rawSection.classList.toggle('hidden');
        toggleRawBtn.innerHTML = rawSection.classList.contains('hidden')
            ? '<i class="fas fa-code mr-2"></i> Toggle Raw Data'
            : '<i class="fas fa-code-slash mr-2"></i> Hide Raw Data';
    });
    
    helpButton.addEventListener('click', () => {
        helpOverlay.classList.remove('hidden');
    });
    
    closeHelpBtn.addEventListener('click', () => {
        helpOverlay.classList.add('hidden');
    });
    
    helpGotItBtn.addEventListener('click', () => {
        helpOverlay.classList.add('hidden');
    });
    
    dismissErrorBtn.addEventListener('click', () => {
        errorAlert.classList.add('hidden');
    });
    
    // Chatbot event listeners
    chatbotButton.addEventListener('click', toggleChatbot);
    
    closeChatbotBtn.addEventListener('click', toggleChatbot);
    
    chatbotSendBtn.addEventListener('click', () => {
        const question = chatbotInputField.value.trim();
        if (question) {
            processChatbotQuestion(question);
        }
    });
    
    chatbotInputField.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const question = chatbotInputField.value.trim();
            if (question) {
                processChatbotQuestion(question);
            }
        }
    });
    
    // Initialize scanner frame when window is resized
    window.addEventListener('resize', initScannerFrame);
    
    // Window load event for scanner frame initialization
    window.addEventListener('load', () => {
        // Initialize scanner frame dimensions
        initScannerFrame();
    });
    
    // Cleanup detection interval when video is stopped
    video.addEventListener('emptied', () => {
        if (video.dataset.detectionInterval) {
            clearInterval(parseInt(video.dataset.detectionInterval));
            delete video.dataset.detectionInterval;
        }
    });
    
    // Start mock license detection when video starts playing
    video.addEventListener('playing', () => {
        simulateLicenseDetection();
    });
    
    // Check for camera support
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showError('Device Not Supported', 'Your device or browser does not support camera access.');
        log('Camera API not supported', 'error');
    }
});
    </script>
</body>
</html>
